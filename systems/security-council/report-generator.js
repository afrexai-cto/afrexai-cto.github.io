#!/usr/bin/env node
// Security Council - Report Generator
// Produces structured markdown report from findings

import { readFileSync, writeFileSync } from 'fs';

const findings = JSON.parse(readFileSync(new URL('./findings.json', import.meta.url), 'utf8'));

const severityOrder = { critical: 0, high: 1, medium: 2, low: 3, info: 4 };
const severityEmoji = { critical: 'ðŸ”´', high: 'ðŸŸ ', medium: 'ðŸŸ¡', low: 'ðŸ”µ', info: 'â„¹ï¸' };
const perspectiveEmoji = { offensive: 'âš”ï¸', defensive: 'ðŸ›¡ï¸', data_privacy: 'ðŸ”’', operational_realism: 'ðŸŽ¯' };
const perspectiveLabel = { offensive: 'Offensive', defensive: 'Defensive', data_privacy: 'Data Privacy', operational_realism: 'Operational Realism' };

const sorted = [...findings.findings].sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);

const counts = {};
for (const f of sorted) {
  counts[f.severity] = (counts[f.severity] || 0) + 1;
}

let md = `# ðŸ›ï¸ Security Council Report

**Scan Date:** ${findings.scannedAt}
**Scan ID:** ${findings.scanId}
**Total Findings:** ${sorted.length}

## Summary

| Severity | Count |
|----------|-------|
${Object.entries(counts).map(([s, c]) => `| ${severityEmoji[s]} ${s.toUpperCase()} | ${c} |`).join('\n')}

## Findings by Perspective

${Object.keys(perspectiveEmoji).map(p => {
  const pFindings = sorted.filter(f => f.perspective === p);
  return `### ${perspectiveEmoji[p]} ${perspectiveLabel[p]} (${pFindings.length} findings)\n` +
    (pFindings.length === 0 ? '_No findings._\n' :
      pFindings.map(f => `- **#${f.finding_number}** ${severityEmoji[f.severity]} \`${f.severity}\` â€” ${f.title}`).join('\n'));
}).join('\n\n')}

---

## Detailed Findings

${sorted.map(f => `### #${f.finding_number} â€” ${severityEmoji[f.severity]} ${f.severity.toUpperCase()}: ${f.title}

| Field | Value |
|-------|-------|
| Perspective | ${perspectiveEmoji[f.perspective]} ${perspectiveLabel[f.perspective]} |
| File | \`${f.file_path || 'N/A'}\` |
| Lines | ${f.line_range || 'N/A'} |

**Description:** ${f.description}

${f.evidence ? `**Evidence:**\n\`\`\`\n${f.evidence}\n\`\`\`\n` : ''}
${f.recommendation ? `**Recommendation:** ${f.recommendation}\n` : ''}
---`).join('\n\n')}

_Report generated by Security Council v1.0.0_
_Use \`node deep-dive.js <finding-number>\` for detailed analysis of any finding._
`;

const outPath = process.argv[2] || 'report.md';
writeFileSync(new URL(`./${outPath}`, import.meta.url), md);
console.log(`ðŸ“„ Report written to ${outPath} (${sorted.length} findings)`);

if (counts.critical > 0) {
  console.log(`\nðŸš¨ ALERT: ${counts.critical} CRITICAL finding(s) require immediate attention!`);
  const criticals = sorted.filter(f => f.severity === 'critical');
  for (const c of criticals) {
    console.log(`   #${c.finding_number}: ${c.title} [${c.file_path}]`);
  }
}
